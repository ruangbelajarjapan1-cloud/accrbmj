<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>RBMJepang</title>
<style>
  :root{--pad:12px;--radius:14px}
  body{font-family:system-ui,Arial,sans-serif;margin:0;background:#f6f7fb;color:#222}
  header{position:sticky;top:0;background:#fff;padding:10px 14px;border-bottom:1px solid #eee;display:flex;gap:10px;align-items:center;z-index:5}
  header img{height:28px}
  header h1{font-size:18px;margin:0}
  .tabs{display:flex;gap:8px;padding:12px 14px;flex-wrap:wrap}
  .tab{padding:8px 12px;background:#fff;border:1px solid #e5e7eb;border-radius:999px;cursor:pointer;user-select:none}
  .tab.active{background:#111827;color:#fff}
  .card{background:#fff;margin:12px;padding:12px;border-radius:var(--radius);box-shadow:0 1px 4px rgba(0,0,0,.06)}
  label{display:block;font-size:12px;color:#555;margin:8px 0 4px}
  input,select,textarea{width:100%;box-sizing:border-box;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fafafa}
  button{width:100%;padding:12px;margin-top:12px;border:0;border-radius:12px;background:#111827;color:#fff;font-weight:600;cursor:pointer}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .hidden{display:none!important}
  .muted{color:#666;font-size:12px}
  .link{color:#0ea5e9;text-decoration:none}
</style>
</head>
<body>
<header>
  <img id="logo" src="./logo.png" alt="logo"/>
  <h1>RBMJepang</h1>
</header>

<div class="tabs">
  <div class="tab active" data-tab="absensi">Absensi</div>
  <div class="tab" data-tab="pembayaran">Pembayaran</div>
  <div class="tab" data-tab="pengeluaran">Pengeluaran</div>
  <div class="tab" data-tab="roster">Roster</div>
  <div class="tab" data-tab="dokumen">Dokumen</div>
  <div class="tab" data-tab="rekap">Rekap</div>
</div>

<!-- ABSENSI -->
<section id="absensi" class="card">
  <div class="row">
    <div><label>Tanggal</label><input id="a_tanggal" type="date"></div>
    <div><label>Kelas</label><select id="a_kelas"></select></div>
  </div>
  <label>Siswa (Roster)</label><select id="a_siswa"></select>
  <label>Status</label>
  <select id="a_status"><option>Hadir</option><option>Izin</option><option>Alpha</option></select>
  <label>Keterangan</label><textarea id="a_ket" rows="2"></textarea>
  <button id="a_submit">Simpan Absensi</button>
  <button id="a_pdf">Cetak & WhatsApp Absensi (PDF)</button>
  <div id="a_pdf_out" class="muted" style="margin-top:6px"></div>
</section>

<!-- PEMBAYARAN -->
<section id="pembayaran" class="card hidden">
  <div class="row">
    <div><label>Tanggal</label><input id="p_tanggal" type="date"></div>
    <div><label>Kelas (untuk SPP & Mukafaah)</label><select id="p_kelas"></select></div>
  </div>
  <div class="row">
    <div><label>Siswa</label><select id="p_siswa"></select></div>
    <div><label>Item</label><input id="p_item" value="SPP"></div>
  </div>
  <div class="row">
    <div>
      <label>Nominal</label><input id="p_nominal" type="number" min="0">
      <div id="p_hint" class="muted"></div>
    </div>
    <div><label>Metode</label><select id="p_metode"><option>Tunai</option><option>Transfer</option></select></div>
  </div>
  <label>Nomor WhatsApp (opsional)</label>
  <input id="p_wa_number" placeholder="contoh: 6281234567890">
  <label>Catatan</label><textarea id="p_catatan" rows="2"></textarea>
  <button id="p_submit">Simpan Pembayaran</button>
  <div id="p_kw" class="hidden" style="margin-top:10px">
    <a id="kw_link" class="link" target="_blank">Buka Kwitansi PDF</a> ·
    <a id="kw_wa" class="link" target="_blank">Kirim via WhatsApp</a>
  </div>
</section>

<!-- PENGELUARAN -->
<section id="pengeluaran" class="card hidden">
  <div class="row">
    <div>
      <label>Tanggal</label>
      <input id="g_tanggal" type="date">
    </div>
    <div>
      <label>Kategori</label>
      <input id="g_kategori" placeholder="Sewa, ATK, Listrik, dll">
    </div>
  </div>
  <label>Nominal</label>
  <input id="g_nominal" type="number" min="0">
  <label>Catatan</label>
  <textarea id="g_catatan" rows="2"></textarea>
  <button id="g_submit">Simpan Pengeluaran</button>
</section>

<!-- ROSTER -->
<section id="roster" class="card hidden">
  <div class="row">
    <div><label>Kelas</label><select id="r_kelas_roster"></select></div>
    <div><label>Tambah Siswa ke Kelas</label><select id="r_siswa_all"></select></div>
  </div>
  <button id="r_add">Tambahkan ke Roster</button>
  <div class="muted" style="margin-top:8px">Daftar siswa di tab Absensi mengikuti Roster aktif.</div>
</section>

<!-- DOKUMEN -->
<section id="dokumen" class="card hidden">
  <h3 style="margin:0 0 8px">Invoice</h3>
  <div class="row">
    <div><label>Bulan</label><input id="inv_bulan" type="month"></div>
    <div><label>Kelas</label><select id="inv_kelas"></select></div>
  </div>
  <div class="row">
    <div><label>Siswa</label><select id="inv_siswa"></select></div>
    <div><label>Jatuh Tempo</label><input id="inv_jt" type="date"></div>
  </div>
  <label>Catatan</label><input id="inv_note">
  <label>Nomor WhatsApp (opsional)</label><input id="inv_wa" placeholder="contoh: 6281234567890">
  <button id="inv_btn">Buat Invoice PDF</button>
  <div id="inv_out" class="muted" style="margin-top:8px"></div>

  <hr style="margin:16px -12px;border:0;border-top:1px solid #eee">
  <h3 style="margin:0 0 8px">Export CSV</h3>
  <div class="row">
    <div><label>Dari</label><input id="ex_dari" type="date"></div>
    <div><label>Sampai</label><input id="ex_sampai" type="date"></div>
  </div>
  <div class="row">
    <div><button id="ex_pb">Export Pembayaran</button></div>
    <div><button id="ex_pg">Export Pengeluaran</button></div>
  </div>
  <div id="ex_out" class="muted" style="margin-top:8px"></div>
</section>

<!-- REKAP -->
<section id="rekap" class="card hidden">
  <div class="row">
    <div><label>Dari Tanggal</label><input id="r_dari" type="date"></div>
    <div><label>Sampai</label><input id="r_sampai" type="date"></div>
  </div>
  <button id="r_keu">Hitung Rekap Keuangan</button>
  <div id="r_keu_out" style="margin-top:8px;font-size:14px;"></div>

  <hr style="margin:16px -12px;border:0;border-top:1px solid #eee">
  <div class="row">
    <div><label>Bulan (YYYY-MM)</label><input id="rk_bulan" type="month"></div>
    <div style="display:flex;align-items:end"><button id="rk_btn">Rekap per Keluarga</button></div>
  </div>
  <div id="rk_out" style="margin-top:8px;font-size:14px;"></div>

  <hr style="margin:16px -12px;border:0;border-top:1px solid #eee">
  <div class="row">
    <div><label>Bulan Mukafaah (YYYY-MM)</label><input id="mk_bulan" type="month"></div>
    <div style="display:flex;align-items:end;gap:8px">
      <button id="mk_hit">Hitung Mukafaah</button>
      <button id="mk_save">Hitung & Simpan ke Sheet</button>
    </div>
  </div>
  <div id="mk_out" style="margin-top:8px;font-size:14px;"></div>
</section>

<script>
// ==== GANTI dengan URL Web App dari Apps Script (…/exec) ====
const BACKEND_URL = 'PASTE_WEB_APP_URL_DI_SINI';

function $(id){return document.getElementById(id);}
function ymdToday(){return new Date().toISOString().slice(0,10);}
function ymThis(){return new Date().toISOString().slice(0,7);}

// API helper: fetch -> fallback JSONP otomatis utk GET
async function api(action, payload={}, method='POST'){
  try{
    const url = BACKEND_URL + '?action=' + encodeURIComponent(action);
    if (method === 'GET'){
      const r = await fetch(url, {method:'GET'});
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'API error');
      return j.data;
    } else {
      const r = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'API error');
      return j.data;
    }
  }catch(e){
    if (method !== 'GET') throw e; // fallback hanya utk GET
    return new Promise((resolve, reject)=>{
      const cb = 'cb_'+Math.random().toString(36).slice(2);
      window[cb] = (j)=>{
        try{ delete window[cb]; document.body.removeChild(s); }catch(_){}
        if(!j || j.ok!==true) return reject(new Error((j&&j.error)||'API error'));
        resolve(j.data);
      };
      const s = document.createElement('script');
      s.src = BACKEND_URL + '?action=' + encodeURIComponent(action) + '&callback=' + cb;
      s.onerror = ()=>{ try{ delete window[cb]; document.body.removeChild(s); }catch(_){}
        reject(new Error('JSONP error')); };
      document.body.appendChild(s);
    });
  }
}

// Tabs
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const id=t.getAttribute('data-tab');
    document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
    $(id).classList.remove('hidden');
  });
});

// Prefill
['a_tanggal','p_tanggal','g_tanggal','r_dari','r_sampai','ex_dari','ex_sampai'].forEach(id=>$(id).value=ymdToday());
['inv_bulan','rk_bulan','mk_bulan'].forEach(id=>$(id).value=ymThis());

// Logo override (fallback ./logo.png)
api('logo_data',{},'GET').then(d=>{ if(d && d.src){ $('logo').src=d.src; } }).catch(()=>{});

// Master load
async function fillKelas(sel, cb){
  const kls = await api('list_kelas', {}, 'GET');
  sel.innerHTML=''; (kls||[]).forEach(k=>sel.add(new Option(k.nama,k.id)));
  if(cb) cb();
}
async function loadKelasAll(){
  await fillKelas($('a_kelas'), ()=>loadSiswaForKelas($('a_kelas').value));
  await fillKelas($('p_kelas'));
  await fillKelas($('r_kelas_roster'));
  await fillKelas($('inv_kelas'), ()=>loadSiswaForInvoice($('inv_kelas').value));
  loadAllSiswaForRoster();
}
loadKelasAll();

async function loadSiswaForKelas(kid){
  if(!kid){ $('a_siswa').innerHTML=''; return; }
  const sis = await api('list_siswa_by_kelas', {kelas_id:kid}, 'GET');
  const sel = $('a_siswa'); sel.innerHTML='';
  (sis||[]).forEach(s=>sel.add(new Option(s.nama,s.id)));
}
$('a_kelas').addEventListener('change', e=>loadSiswaForKelas(e.target.value));

async function loadSiswaForInvoice(kid){
  if(!kid){ $('inv_siswa').innerHTML=''; return; }
  const sis = await api('list_siswa_by_kelas', {kelas_id:kid}, 'GET');
  const sel = $('inv_siswa'); sel.innerHTML='';
  (sis||[]).forEach(s=>sel.add(new Option(s.nama,s.id)));
}
$('inv_kelas').addEventListener('change', e=>loadSiswaForInvoice(e.target.value));

async function loadAllSiswaForRoster(){
  const sis = await api('list_all_siswa', {}, 'GET');
  const sel1=$('p_siswa'), sel2=$('r_siswa_all'); sel1.innerHTML=''; sel2.innerHTML='';
  (sis||[]).forEach(s=>{
    const label=s.nama+(s.keluarga?(' / '+s.keluarga+'-'+s.anak_ke):'');
    sel1.add(new Option(label,s.id));
    sel2.add(new Option(label,s.id));
  });
  tryPreviewSPP();
}

// Roster
$('r_add').addEventListener('click', async ()=>{
  const payload = { kelas_id:$('r_kelas_roster').value, siswa_id:$('r_siswa_all').value };
  if(!payload.kelas_id || !payload.siswa_id){ alert('Pilih kelas & siswa'); return; }
  await api('roster_add', payload, 'POST');
  alert('Ditambahkan ke roster');
});

// Absensi
$('a_submit').addEventListener('click', async ()=>{
  const payload = {
    tanggal:$('a_tanggal').value, kelas_id:$('a_kelas').value, siswa_id:$('a_siswa').value,
    status:$('a_status').value, keterangan:$('a_ket').value
  };
  if(!payload.tanggal||!payload.kelas_id||!payload.siswa_id){ alert('Lengkapi tanggal, kelas, siswa'); return; }
  await api('save_absensi', payload, 'POST');
  alert('Absensi tersimpan');
});
$('a_pdf').addEventListener('click', async ()=>{
  const payload = { tanggal:$('a_tanggal').value, kelas_id:$('a_kelas').value };
  if(!payload.tanggal||!payload.kelas_id){ alert('Pilih tanggal & kelas'); return; }
  $('a_pdf_out').innerHTML='Membuat PDF...';
  const doc = await api('generate_absensi_pdf', payload, 'POST');
  $('a_pdf_out').innerHTML = `<a class="link" href="${doc.url}" target="_blank">Buka Absensi PDF</a> · <a class="link" href="${doc.wa}" target="_blank">Kirim via WhatsApp</a>`;
  window.open(doc.wa,'_blank');
});

// Preview SPP
async function tryPreviewSPP(){
  const item = ($('p_item').value||'').trim().toUpperCase();
  const siswa_id = $('p_siswa').value;
  const kelas_id = $('p_kelas').value;
  if(item==='SPP' && siswa_id && kelas_id){
    try{
      const res = await api('spp_preview', {kelas_id, siswa_id}, 'GET');
      if(res && Number(res.nominal)>0){
        $('p_nominal').value = res.nominal;
        $('p_hint').textContent = (res.alasan? (res.alasan+' • '):'') + 'Tarif: ¥'+Number(res.tarif||0).toLocaleString()+' → Bayar: ¥'+Number(res.nominal||0).toLocaleString();
      } else {
        $('p_nominal').value=''; $('p_hint').textContent='Tarif SPP belum di-set di Referensi.';
      }
    }catch{ $('p_hint').textContent=''; }
  } else { $('p_nominal').value=''; $('p_hint').textContent=''; }
}
['p_item','p_siswa','p_kelas'].forEach(id=>$(id).addEventListener('change', tryPreviewSPP));

// Pembayaran + Kwitansi
$('p_submit').addEventListener('click', async ()=>{
  const tanggal = $('p_tanggal').value;
  const payload = {
    tanggal, periode:(tanggal||'').slice(0,7), kelas_id:$('p_kelas').value, siswa_id:$('p_siswa').value,
    item:$('p_item').value, nominal:$('p_nominal').value, metode:$('p_metode').value,
    catatan:$('p_catatan').value
  };
  if(!payload.tanggal || !payload.siswa_id || !payload.item){ alert('Lengkapi tanggal, siswa, item'); return; }
  const saved = await api('save_pembayaran', payload, 'POST');
  const doc = await api('generate_kwitansi', { pembayaran_id:saved.id, wa_number:$('p_wa_number').value }, 'POST');
  $('p_kw').classList.remove('hidden');
  $('kw_link').href = doc.url;
  $('kw_wa').href = doc.wa;
  window.open(doc.wa,'_blank');
});

// Pengeluaran
$('g_submit').addEventListener('click', async ()=>{
  const payload = {
    tanggal: $('g_tanggal').value,
    kategori: $('g_kategori').value,
    nominal:  $('g_nominal').value,
    catatan:  $('g_catatan').value
  };
  if(!payload.tanggal || !payload.kategori || !payload.nominal){
    alert('Lengkapi tanggal, kategori, dan nominal'); return;
  }
  await api('save_pengeluaran', payload, 'POST');
  alert('Pengeluaran tersimpan');
  $('g_kategori').value=''; $('g_nominal').value=''; $('g_catatan').value='';
});

// Invoice
$('inv_btn').addEventListener('click', async ()=>{
  const payload = {
    bulan:$('inv_bulan').value, kelas_id:$('inv_kelas').value, siswa_id:$('inv_siswa').value,
    jatuh_tempo:$('inv_jt').value, catatan:$('inv_note').value, wa_number:$('inv_wa').value
  };
  if(!payload.bulan||!payload.kelas_id||!payload.siswa_id){ alert('Lengkapi bulan, kelas, siswa'); return; }
  $('inv_out').innerHTML='Membuat Invoice...';
  const doc = await api('generate_invoice', payload, 'POST');
  $('inv_out').innerHTML = `<a class="link" href="${doc.url}" target="_blank">Buka Invoice PDF</a> · <a class="link" href="${doc.wa}" target="_blank">Bagikan via WhatsApp</a>`;
  window.open(doc.wa,'_blank');
});

// Export CSV
$('ex_pb').addEventListener('click', async ()=>{
  const range = { jenis:'pembayaran', dari:$('ex_dari').value, sampai:$('ex_sampai').value };
  $('ex_out').innerHTML='Mengekspor...';
  const r = await api('export_csv', range, 'POST');
  $('ex_out').innerHTML = r && r.url ? `<a class="link" href="${r.url}" target="_blank">Download CSV Pembayaran</a>` : 'Tidak ada data.';
});
$('ex_pg').addEventListener('click', async ()=>{
  const range = { jenis:'pengeluaran', dari:$('ex_dari').value, sampai:$('ex_sampai').value };
  $('ex_out').innerHTML='Mengekspor...';
  const r = await api('export_csv', range, 'POST');
  $('ex_out').innerHTML = r && r.url ? `<a class="link" href="${r.url}" target="_blank">Download CSV Pengeluaran</a>` : 'Tidak ada data.';
});

// Rekap
$('r_keu').addEventListener('click', async ()=>{
  const range = { dari:$('r_dari').value, sampai:$('r_sampai').value };
  $('r_keu_out').innerHTML='Menghitung...';
  const sum = await api('rekap_keuangan', range, 'POST');
  $('r_keu_out').innerHTML = `<b>Ringkasan Keuangan</b><br/>
    Pemasukan: <b>¥${Number(sum.pemasukan||0).toLocaleString()}</b><br/>
    Pengeluaran: <b>¥${Number(sum.pengeluaran||0).toLocaleString()}</b><br/>
    Saldo: <b>¥${Number(sum.saldo||0).toLocaleString()}</b><br/>
    Transaksi Masuk: ${sum.transaksi_masuk||0} | Keluar: ${sum.transaksi_keluar||0}`;
});

$('rk_btn').addEventListener('click', async ()=>{
  const bulan = $('rk_bulan').value;
  if(!bulan){ alert('Pilih bulan'); return; }
  $('rk_out').innerHTML='Menghitung...';
  const rows = await api('rekap_per_keluarga', {bulan}, 'POST');
  if(!rows || !rows.length){ $('rk_out').innerHTML='Tidak ada data.'; return; }
  const html = ['<b>Rekap SPP per Keluarga</b><br/><table style="width:100%;border-collapse:collapse;font-size:12px;"><tr><th style="padding:4px;border:1px solid #ddd;text-align:left">Keluarga</th><th style="padding:4px;border:1px solid #ddd;text-align:left">Anggota</th><th style="padding:4px;border:1px solid #ddd;">Total</th></tr>'];
  rows.forEach(r=>{
    html.push(`<tr><td style="padding:4px;border:1px solid #ddd;">${r.keluarga}</td><td style="padding:4px;border:1px solid #ddd;">${r.siswa}</td><td style="padding:4px;border:1px solid #ddd;text-align:right">¥${Number(r.total||0).toLocaleString()}</td></tr>`);
  });
  html.push('</table>');
  $('rk_out').innerHTML=html.join('');
});

function renderMukafaah(res){
  const items = (res && res.items)||[];
  if(!items.length){ $('mk_out').innerHTML='Tidak ada data.'; return;}
  const ratePct = (Number(res.rate||0)*100).toFixed(0);
  const rows = items.map(i=>`<tr>
    <td style="padding:4px;border:1px solid #ddd;">${i.kelas_nama}</td>
    <td style="padding:4px;border:1px solid #ddd;text-align:right">¥${Number(i.total_spp||0).toLocaleString()}</td>
    <td style="padding:4px;border:1px solid #ddd;text-align:right">${ratePct}%</td>
    <td style="padding:4px;border:1px solid #ddd;text-align:right">¥${Number(i.nominal_mukafaah||0).toLocaleString()}</td>
  </tr>`).join('');
  $('mk_out').innerHTML = `<b>Mukafaah per Kelas</b><br/>
  <table style="width:100%;border-collapse:collapse;font-size:12px;">
  <tr><th style="padding:4px;border:1px solid #ddd;">Kelas</th><th style="padding:4px;border:1px solid #ddd;">Total SPP</th><th style="padding:4px;border:1px solid #ddd;">Persen</th><th style="padding:4px;border:1px solid #ddd;">Mukafaah</th></tr>${rows}</table>`;
}
$('mk_hit').addEventListener('click', async ()=>{
  const bulan=$('mk_bulan').value; if(!bulan){ alert('Pilih bulan'); return; }
  $('mk_out').innerHTML='Menghitung...';
  renderMukafaah(await api('mukafaah_hitung',{bulan,save:false},'POST'));
});
$('mk_save').addEventListener('click', async ()=>{
  const bulan=$('mk_bulan').value; if(!bulan){ alert('Pilih bulan'); return; }
  $('mk_out').innerHTML='Menghitung dan menyimpan...';
  const res = await api('mukafaah_hitung',{bulan,save:true},'POST');
  renderMukafaah(res); alert('Mukafaah tersimpan');
});
</script>
</body>
</html>
