<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RBMJ Portal (Web)</title>
<style>
:root{--bg:#f8fafc;--card:#fff;--line:#e5e7eb;--text:#111827;--muted:#6b7280;--primary:#2563eb}
*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,Segoe UI,Arial,sans-serif}
body{margin:0;background:var(--bg);color:var(--text)}
.wrap{max-width:980px;margin:0 auto;padding:12px}
.header{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:8px}
.brand{font-weight:700}
.sub{color:var(--muted);font-size:12px}
.tabs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
.tab{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
.tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:10px}
.row{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-bottom:10px;align-items:center}
@media (max-width:640px){ .row{grid-template-columns:1fr} }
label{font-size:12px;color:var(--muted)}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
textarea{min-height:80px}
.btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:10px;border:1px solid var(--primary);background:var(--primary);color:#fff;cursor:pointer;font-weight:600}
.btn.secondary{background:#fff;color:var(--primary)}
.grid{width:100%;border-collapse:collapse;margin-top:8px;font-size:12px}
.grid th,.grid td{border:1px solid var(--line);padding:6px}
.grid th{background:#f3f4f6;text-align:left}
.right{text-align:right}
.tiny{font-size:11px}.muted{color:var(--muted)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:12px;z-index:50}
.modal>.box{background:#fff;border:1px solid var(--line);border-radius:12px;max-width:880px;width:100%;max-height:80vh;overflow:auto}
.modal .head{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid var(--line)}
.modal .body{padding:10px}
.close{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer}
.banner{position:sticky;bottom:0;background:#111827;color:#fff;padding:10px;border-radius:10px;margin-top:8px;display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <div class="brand" id="brandName">RBMJ</div>
      <div class="sub" id="brandTag">Portal Administrasi (Web)</div>
    </div>
    <div class="sub" id="brandLink"></div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="pay">Pembayaran SPP</button>
    <button class="tab" data-tab="invoice">Surat/Invoice</button>
    <button class="tab" data-tab="pengeluaran">Pengeluaran</button>
    <button class="tab" data-tab="mukafaah">Mukafaah</button>
    <button class="tab" data-tab="roster">Roster</button>
    <button class="tab" data-tab="absen">Absensi</button>
    <button class="tab" data-tab="resume">Resume</button>
  </div>

  <!-- PAY -->
  <div class="card" id="tab-pay">
    <div class="row"><label>Kelas</label><select id="payKelas"></select></div>
    <div class="row"><label>Hanya Aktif?</label><select id="payOnly"><option value="true">Ya</option><option value="false">Tidak</option></select></div>
    <div class="row"><label>Siswa</label><select id="payNis"></select></div>
    <div class="row"><label>Periode</label><input id="payPeriode" placeholder="YYYY-MM"></div>
    <div class="row"><label>Metode</label><select id="payMetode"></select></div>
    <div class="row"><label>Nominal</label><input id="payNominal" inputmode="numeric" class="right"></div>
    <div class="row"><label>Keterangan</label><input id="payKet" placeholder="opsional"></div>
    <div>
      <button class="btn" id="btnPay">Simpan & Kwitansi</button>
      <button class="btn secondary" id="btnHist">Riwayat per NIS</button>
    </div>
    <div id="payRes" class="tiny muted" style="margin-top:8px"></div>
  </div>

  <!-- INVOICE -->
  <div class="card" id="tab-invoice" style="display:none">
    <div class="row"><label>Kelas</label><select id="invKelas"></select></div>
    <div class="row"><label>Hanya Aktif?</label><select id="invOnly"><option value="true">Ya</option><option value="false">Tidak</option></select></div>
    <div class="row"><label>Siswa</label><select id="invNis"></select></div>
    <div class="row"><label>Periode</label><input id="invPeriode" placeholder="YYYY-MM"></div>
    <div class="row"><label>Jumlah</label><input id="invJumlah" inputmode="numeric" class="right"></div>
    <div class="row"><label>Jatuh Tempo</label><input id="invJt" type="date"></div>
    <button class="btn" id="btnInvoice">Buat Surat/Invoice (PDF)</button>
    <div id="invRes" class="tiny muted" style="margin-top:8px"></div>
  </div>

  <!-- PENGELUARAN -->
  <div class="card" id="tab-pengeluaran" style="display:none">
    <div class="row"><label>Tanggal</label><input id="outTgl" type="date"></div>
    <div class="row"><label>Kategori</label><input id="outKat"></div>
    <div class="row"><label>Deskripsi</label><textarea id="outDesk"></textarea></div>
    <div class="row"><label>Nominal</label><input id="outNom" inputmode="numeric" class="right"></div>
    <div class="row"><label>Dibayar oleh</label><input id="outBy"></div>
    <button class="btn" id="btnOut">Simpan Pengeluaran</button>
    <div id="outRes" class="tiny muted" style="margin-top:8px"></div>
  </div>

  <!-- MUKAFAAH -->
  <div class="card" id="tab-mukafaah" style="display:none">
    <div class="row"><label>Periode</label><input id="mukPeriode" placeholder="YYYY-MM"></div>
    <button class="btn" id="btnMukHitung">Hitung/Refresh</button>
    <div id="mukRes" class="tiny muted" style="margin-top:8px"></div>
    <hr style="border:none;border-top:1px solid var(--line);margin:10px 0">
    <div class="row"><label>Tanggal Bayar</label><input id="mukTgl" type="date"></div>
    <div class="row"><label>Dibayar oleh</label><input id="mukBy"></div>
    <div class="row"><label>Metode</label><input id="mukMet"></div>
    <button class="btn" id="btnMukBayar">Bayar Semua (Belum)</button>
    <div id="mukBayarRes" class="tiny muted" style="margin-top:8px"></div>
  </div>

  <!-- ROSTER -->
  <div class="card" id="tab-roster" style="display:none">
    <div class="row"><label>Kelas</label><select id="rosKelas"></select></div>
    <div class="row"><label>Hanya Aktif?</label><select id="rosOnly"><option value="true">Ya</option><option value="false">Tidak</option></select></div>
    <table class="grid"><thead><tr><th>NIS</th><th>Nama</th><th>NoHP</th></tr></thead><tbody id="rosBody"></tbody></table>
  </div>

  <!-- ABSENSI -->
  <div class="card" id="tab-absen" style="display:none">
    <div class="row"><label>Kelas</label><select id="absKelas"></select></div>
    <div class="row"><label>Tanggal</label><input id="absTgl" type="date"></div>
    <button class="btn" id="btnAbsen">Buat Template Absensi</button>
    <div id="absRes" class="tiny muted" style="margin-top:8px"></div>
  </div>

  <!-- RESUME -->
  <div class="card" id="tab-resume" style="display:none">
    <div class="row"><label>Kelas</label><select id="sumKelas"></select></div>
    <div class="row"><label>Periode</label><input id="sumPeriode" placeholder="YYYY-MM"></div>
    <div class="row"><label>Hanya Aktif?</label><select id="sumOnly"><option value="true">Ya</option><option value="false">Tidak</option></select></div>
    <table class="grid"><tbody><tr><th>Jumlah Siswa</th><td id="sumSiswa">-</td></tr><tr><th>Total SPP</th><td id="sumSPP">-</td></tr></tbody></table>
  </div>

  <!-- Modal Riwayat -->
  <div class="modal" id="histModal">
    <div class="box">
      <div class="head">
        <div><b>Riwayat Pembayaran</b> â€” <span id="histNis" class="muted"></span></div>
        <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
          <input id="histPeriode" placeholder="YYYY-MM" style="padding:6px 10px;border:1px solid var(--line);border-radius:10px;width:130px">
          <button class="close" id="btnHistFilter">Filter</button>
          <button class="close" id="btnHistCsv">Export CSV</button>
          <button class="close" id="btnHistClose">Tutup</button>
        </div>
      </div>
      <div class="body">
        <table class="grid"><thead><tr><th>Tanggal</th><th>Periode</th><th class="right">Nominal</th><th>Metode</th><th>Keterangan</th><th>NoKwitansi</th></tr></thead><tbody id="histBody"></tbody></table>
      </div>
    </div>
  </div>

  <div class="banner" id="netErr">Tidak bisa menjangkau API. Coba nonaktifkan VPN/Private DNS/ad-blocker untuk domain Google, lalu reload.</div>
</div>

<script>
/* ======= KONFIG ======= */
const GAS_BASE = 'https://script.google.com/macros/s/AKfycbwKh033sPydZWdtw4Iv4wX7d-VQUa10tqbtJP8FyvPEe6gB7_mJxJ6qBHlX94aacSAz/exec'; // <<<<<<<<<<<<<< set ke URL /exec

/* ======= UTILS ======= */
const $ = id => document.getElementById(id);
const esc = s => String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));
const rupiah = n => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(Number(n||0));
const getJSON = async (params) => {
  const url = GAS_BASE + (GAS_BASE.includes('?')?'&':'?') + new URLSearchParams(params).toString();
  try{
    const r = await fetch(url, {mode:'cors',cache:'no-store'});
    const t = await r.text();
    try{ return JSON.parse(t); }catch{ return {ok:false,error:'Bad JSON',raw:t}; }
  }catch(e){ $('netErr').style.display='block'; throw e; }
};
const postJSON = async (action, body) => {
  try{
    const r = await fetch(GAS_BASE + (GAS_BASE.includes('?')?'&':'?') + 'action=' + encodeURIComponent(action), {
      method:'POST', mode:'cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}), cache:'no-store'
    });
    return await r.json();
  }catch(e){ $('netErr').style.display='block'; throw e; }
};

/* ======= TABS ======= */
document.querySelectorAll('.tab').forEach(b=>{
  b.onclick = () => {
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const id=b.dataset.tab;
    ['pay','invoice','pengeluaran','mukafaah','roster','absen','resume'].forEach(t=>{
      $('tab-'+t).style.display = (t===id)?'block':'none';
    });
  };
});

/* ======= INIT ======= */
(async function init(){
  try{
    const br = await getJSON({action:'brand'});
    if (br.ok && br.data){
      $('brandName').textContent = br.data.name || 'RBMJ';
      $('brandTag').textContent  = br.data.tagline || '';
      $('brandLink').innerHTML   = br.data.webUrl ? `Web App: <a href="${br.data.webUrl}" target="_blank">${esc(br.data.webUrl)}</a>` : '';
    }
  }catch(_){}

  const kls = await getJSON({action:'listKelas'});
  const metode = await getJSON({action:'listMetode'});
  const setOpts = (sel, arr, map=v=>({value:v,label:v}))=>{
    sel.innerHTML = (arr.data||[]).map(v=>{const {value,label}=map(v);return `<option value="${esc(value)}">${esc(label)}</option>`}).join('');
  };
  ['payKelas','invKelas','rosKelas','absKelas','sumKelas'].forEach(id=> setOpts($(id), kls.data||[]));
  setOpts($('payMetode'), metode.data||[]);

  const now = new Date(), ym = now.toISOString().slice(0,7);
  ['payPeriode','invPeriode','sumPeriode','mukPeriode'].forEach(id=> $(id).value = ym);
  $('invJt').value = new Date(Date.now()+7*24*3600*1000).toISOString().slice(0,10);
  $('absTgl').value = now.toISOString().slice(0,10);
  $('mukTgl').value = now.toISOString().slice(0,10);
  $('outTgl').value = now.toISOString().slice(0,10);

  refreshPayStudents(); refreshInvStudents(); refreshRoster(); refreshResume();
})();

/* ======= PAY ======= */
async function refreshPayStudents(){
  const kelas=$('payKelas').value, only= $('payOnly').value==='true';
  const r = await getJSON({action:'listSiswaByKelas', kelas, onlyActive:String(only)});
  $('payNis').innerHTML = (r.data||[]).map(s=>`<option value="${esc(s.nis)}">${esc(s.nis+' â€” '+s.nama)}</option>`).join('');
  if ((r.data||[]).length){
    const n = await getJSON({action:'computeTarif', nis:r.data[0].nis, periode:$('payPeriode').value, kelas});
    $('payNominal').value = n.data || '';
  }
}
$('payKelas').onchange = refreshPayStudents;
$('payOnly').onchange = refreshPayStudents;
$('payNis').onchange = async ()=>{
  if (!$('payNis').value) return;
  const n = await getJSON({action:'computeTarif', nis:$('payNis').value, periode:$('payPeriode').value, kelas:$('payKelas').value});
  $('payNominal').value = n.data || '';
};
$('payPeriode').onchange = $('payNis').onchange;

$('btnPay').onclick = async ()=>{
  const nis=$('payNis').value, prd=$('payPeriode').value, nominal=Number($('payNominal').value||0),
        metode=$('payMetode').value, ket=$('payKet').value, kelas=$('payKelas').value;
  if(!nis || !prd || !nominal){ $('payRes').textContent='Lengkapi data'; return; }
  $('btnPay').disabled=true; $('payRes').textContent='Memproses...';
  const r = await postJSON('createPayment', {nis,periode:prd,nominal,metode,ket,kelas});
  $('btnPay').disabled=false;
  $('payRes').innerHTML = r.ok ? `OK. <a href="${esc(r.data)}" target="_blank">Buka Kwitansi PDF</a>` : ('Error: '+esc(r.error));
};

/* ======= Riwayat + CSV ======= */
let HROWS=[];
$('btnHist').onclick = async ()=>{
  const nis=$('payNis').value; if(!nis) return alert('Pilih NIS dulu.');
  $('histNis').textContent = nis; $('histBody').innerHTML='<tr><td colspan="6" class="muted">Memuat...</td></tr>';
  $('histModal').style.display='flex';
  const r = await getJSON({action:'paymentHistory', nis});
  HROWS = (r.data||[]);
  renderHist();
};
$('btnHistFilter').onclick = async ()=>{
  const nis=$('payNis').value, per=$('histPeriode').value.trim();
  $('histBody').innerHTML='<tr><td colspan="6" class="muted">Memuat...</td></tr>';
  const r = await getJSON({action:'paymentHistory', nis, periode:per});
  HROWS = (r.data||[]); renderHist();
};
$('btnHistCsv').onclick = ()=>{
  if(!HROWS.length) return alert('Tidak ada data.');
  const head=['Tanggal','Periode','Nominal','Metode','Keterangan','NoKwitansi'];
  const lines = HROWS.map(r=>[r.tanggal||'',r.periode||'',Number(r.nominal||0),r.metode||'',r.ket||'',r.kwitansi||'']
    .map(s=>{s=String(s);return /[",\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s;}).join(','));
  const csv = head.join(',')+'\r\n'+lines.join('\r\n');
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download='riwayat_'+($('payNis').value||'')+(($('histPeriode').value||'')?('_'+$('histPeriode').value):'')+'.csv';
  document.body.appendChild(a); a.click(); a.remove();
};
$('btnHistClose').onclick = ()=>{ $('histModal').style.display='none'; };
function renderHist(){
  $('histBody').innerHTML = HROWS.length? HROWS.map(r=>`
    <tr><td>${esc(r.tanggal||'')}</td><td>${esc(r.periode||'')}</td>
    <td class="right">${esc(new Intl.NumberFormat('id-ID').format(r.nominal||0))}</td>
    <td>${esc(r.metode||'')}</td><td>${esc(r.ket||'')}</td><td>${esc(r.kwitansi||'')}</td></tr>
  `).join('') : '<tr><td colspan="6" class="muted">Tidak ada data.</td></tr>';
}

/* ======= INVOICE ======= */
async function refreshInvStudents(){
  const kelas=$('invKelas').value, only=$('invOnly').value==='true';
  const r = await getJSON({action:'listSiswaByKelas', kelas, onlyActive:String(only)});
  $('invNis').innerHTML = (r.data||[]).map(s=>`<option value="${esc(s.nis)}">${esc(s.nis+' â€” '+s.nama)}</option>`).join('');
  if ((r.data||[]).length){
    const n = await getJSON({action:'computeTarif', nis:r.data[0].nis, periode:$('invPeriode').value, kelas});
    $('invJumlah').value = n.data || '';
  }
}
$('invKelas').onchange=refreshInvStudents; $('invOnly').onchange=refreshInvStudents;
$('invNis').onchange = async ()=>{
  if (!$('invNis').value) return;
  const n = await getJSON({action:'computeTarif', nis:$('invNis').value, periode:$('invPeriode').value, kelas:$('invKelas').value});
  $('invJumlah').value = n.data || '';
};
$('invPeriode').onchange = $('invNis').onchange;
$('btnInvoice').onclick = async ()=>{
  const pay = { nis:$('invNis').value, periode:$('invPeriode').value, jumlah:Number($('invJumlah').value||0), jtISO:$('invJt').value, kelas:$('invKelas').value };
  if(!pay.nis || !pay.periode || !pay.jumlah || !pay.jtISO){ $('invRes').textContent='Lengkapi data.'; return; }
  $('btnInvoice').disabled=true; $('invRes').textContent='Memproses...';
  const r = await postJSON('createInvoice', pay);
  $('btnInvoice').disabled=false; $('invRes').innerHTML = r.ok ? `OK. <a target="_blank" href="${esc(r.data)}">Buka PDF</a>` : ('Error: '+esc(r.error));
};

/* ======= PENGELUARAN ======= */
$('btnOut').onclick = async ()=>{
  const body={ tglISO:$('outTgl').value, kategori:$('outKat').value, deskripsi:$('outDesk').value, nominal:Number($('outNom').value||0), by:$('outBy').value };
  if(!body.tglISO || !body.kategori || !body.deskripsi || !body.nominal || !body.by){ $('outRes').textContent='Lengkapi semua field.'; return; }
  $('btnOut').disabled=true; $('outRes').textContent='Memproses...';
  const r = await postJSON('addExpense', body);
  $('btnOut').disabled=false; $('outRes').textContent = r.ok? ('OK. ID: '+(r.data.id||'')) : ('Error: '+esc(r.error));
};

/* ======= MUKAFAAH ======= */
$('btnMukHitung').onclick = async ()=>{
  const periode=$('mukPeriode').value; if(!periode) return $('mukRes').textContent='Isi periode.';
  $('btnMukHitung').disabled=true; $('mukRes').textContent='Memproses...';
  const r = await postJSON('mukHitung', {periode});
  $('btnMukHitung').disabled=false; $('mukRes').textContent = r.ok? `Kelas: ${r.data.count} â€¢ Total SPP: ${rupiah(r.data.totalSPP)} â€¢ Mukafaah: ${rupiah(r.data.totalMuk)}` : ('Error: '+esc(r.error));
};
$('btnMukBayar').onclick = async ()=>{
  const body={periode:$('mukPeriode').value, tglISO:$('mukTgl').value, by:$('mukBy').value, metode:$('mukMet').value};
  if(!body.periode || !body.tglISO || !body.by){ $('mukBayarRes').textContent='Lengkapi data'; return; }
  $('btnMukBayar').disabled=true; $('mukBayarRes').textContent='Memproses...';
  const r = await postJSON('mukBayarAll', body);
  $('btnMukBayar').disabled=false; $('mukBayarRes').textContent = r.ok? `Slip terbayar: ${r.data.paidCount} â€¢ Total: ${rupiah(r.data.totalMuk)}` : ('Error: '+esc(r.error));
};

/* ======= ROSTER ======= */
async function refreshRoster(){
  const kelas=$('rosKelas').value, only=$('rosOnly').value==='true';
  const r = await getJSON({action:'roster', kelas, onlyActive:String(only)});
  if (!r.ok) { $('rosBody').innerHTML = `<tr><td colspan="3" class="muted">Error: ${esc(r.error||'gagal memuat')}</td></tr>`; return; }
  $('rosBody').innerHTML = (r.data||[]).map(x=>`<tr><td>${esc(x[0]||'')}</td><td>${esc(x[1]||'')}</td><td>${esc(x[4]||'')}</td></tr>`).join('');
}
$('rosKelas').onchange=refreshRoster; $('rosOnly').onchange=refreshRoster;

/* ======= ABSENSI ======= */
$('btnAbsen').onclick = async ()=>{
  const kelas=$('absKelas').value, tglISO=$('absTgl').value;
  if(!kelas || !tglISO) return;
  $('btnAbsen').disabled=true; $('absRes').textContent='Membuat template...';
  const r = await getJSON({action:'prepareAbsensi', kelas, tglISO});
  $('btnAbsen').disabled=false; $('absRes').textContent = r.ok? `Template dibuat untuk ${esc(kelas)} (${esc(tglISO)})` : ('Error: '+esc(r.error));
};

/* ======= RESUME ======= */
async function refreshResume(){
  const kelas=$('sumKelas').value, periode=$('sumPeriode').value, only=$('sumOnly').value==='true';
  const r = await getJSON({action:'kelasResume', kelas, periode, onlyActive:String(only)});
  if (r.ok && r.data){ $('sumSiswa').textContent=r.data.siswaAktif; $('sumSPP').textContent=r.data.totalSPPLabel; }
}
['sumKelas','sumPeriode','sumOnly'].forEach(id=> $(id).onchange=refreshResume);
</script>
</body>
</html>
