<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>RBMJ Portal (Web)</title>
  <style>
    :root{ --bg:#f8fafc; --card:#fff; --line:#e5e7eb; --text:#111827; --muted:#6b7280;
           --primary:#2563eb; --primary-600:#1d4ed8; }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Inter,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:auto;padding:18px}
    h1{font-size:20px;margin:0 0 12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .tab{padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-size:13px}
    .tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:grid;grid-template-columns:140px 1fr;gap:8px;margin-bottom:10px;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px;background:#fff}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:10px;border:1px solid var(--primary);background:var(--primary);color:#fff;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--primary)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .grid{width:100%;border-collapse:collapse;margin-top:8px;font-size:12px}
    .grid th,.grid td{border:1px solid var(--line);padding:6px}
    .grid th{background:#f3f4f6;text-align:left}
    .tiny{font-size:12px}
    .muted{color:var(--muted)}
    .mt8{margin-top:8px}
  </style>
  <script>
    // ==== KONFIG: Ganti URL dengan Web App Apps Script  ====
    window.RBMJ_API_BASE = 'https://script.google.com/macros/s/AKfycbx7qGUynZxSI1uyByZaOTDdGXvL6MzwTRSQLdN-r9682-eKe918UPvMKyN2WESc31bX/exec';
  </script>
</head>
<body>
  <div class="wrap">
    <h1 id="brandTitle">Ruang Belajar Muslim Jepang</h1>
    <div class="tabs">
      <button class="tab active" data-tab="pay">Pembayaran SPP</button>
      <button class="tab" data-tab="inv">Surat/Invoice</button>
      <button class="tab" data-tab="out">Pengeluaran</button>
      <button class="tab" data-tab="muk">Mukafaah</button>
      <button class="tab" data-tab="ros">Roster</button>
      <button class="tab" data-tab="abs">Absensi</button>
      <button class="tab" data-tab="sum">Resume</button>
    </div>

    <!-- ===== Pembayaran (ringkas, placeholder) ===== -->
    <div class="card" id="tab-pay">
      <div class="row"><label>Kelas</label><select id="payKelas"></select></div>
      <div class="row"><label>Hanya Aktif?</label><select id="payOnly"><option value="true" selected>Ya</option><option value="false">Tidak</option></select></div>
      <div class="row"><label>Siswa</label><select id="payNis"></select></div>
      <div class="row"><label>Periode</label><input id="payPeriode" placeholder="YYYY-MM"></div>
      <div class="row"><label>Metode</label><select id="payMetode"></select></div>
      <div class="row"><label>Nominal</label><input id="payNominal" placeholder="otomatis"></div>
      <div class="row"><label>Keterangan</label><input id="payKet" placeholder="opsional"></div>
      <div class="mt8">
        <button class="btn" id="btnPay">Simpan & Kwitansi</button>
        <button class="btn secondary" id="btnHist">Riwayat per NIS</button>
      </div>
      <div id="payInfo" class="tiny muted mt8"></div>
    </div>

    <!-- ===== Invoice (placeholder) ===== -->
    <div class="card" id="tab-inv" style="display:none">
      <div class="tiny muted">Buat Surat/Invoice (fitur sama seperti portal Apps Script).</div>
    </div>

    <!-- ===== Pengeluaran (placeholder) ===== -->
    <div class="card" id="tab-out" style="display:none">
      <div class="row"><label>Tanggal</label><input type="date" id="outTgl"></div>
      <div class="row"><label>Kategori</label><input id="outKat" placeholder="contoh: Operasional"></div>
      <div class="row"><label>Deskripsi</label><input id="outDesk"></div>
      <div class="row"><label>Nominal</label><input id="outNom"></div>
      <div class="row"><label>Dibayar Oleh</label><input id="outBy"></div>
      <button class="btn" id="btnOut">Simpan</button>
      <div id="outInfo" class="tiny muted mt8"></div>
    </div>

    <!-- ===== Mukafaah (placeholder) ===== -->
    <div class="card" id="tab-muk" style="display:none">
      <div class="tiny muted">Hitung/bayar mukafaah tersedia di menu terpisah (tidak diuraikan di contoh ini).</div>
    </div>

    <!-- ===== Roster (placeholder) ===== -->
    <div class="card" id="tab-ros" style="display:none">
      <div class="row"><label>Kelas</label><select id="rosKelas"></select></div>
      <div class="row"><label>Hanya Aktif?</label><select id="rosOnly"><option value="true" selected>Ya</option><option value="false">Tidak</option></select></div>
      <table class="grid" id="rosTable"><thead><tr><th>NIS</th><th>Nama</th></tr></thead><tbody></tbody></table>
    </div>

    <!-- ===== Absensi (lengkap + Share WA) ===== -->
    <div class="card" id="tab-abs" style="display:none">
      <div class="row">
        <label>Kelas</label>
        <select id="absKelas"></select>
      </div>
      <div class="row">
        <label>Tanggal</label>
        <input id="absTanggal" type="date">
      </div>
      <div class="mt8">
        <button class="btn" id="btnAbsen">Buat Template Absensi</button>
        <button class="btn secondary" id="btnShareWA" disabled>Bagikan via WhatsApp</button>
      </div>
      <div id="absInfo" class="tiny muted mt8"></div>
      <table class="grid mt8" id="absTable" style="display:none">
        <thead><tr><th style="width:90px">NIS</th><th>Nama</th><th style="width:110px">Kehadiran</th><th>Keterangan</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ===== Resume (placeholder) ===== -->
    <div class="card" id="tab-sum" style="display:none">
      <div class="row"><label>Kelas</label><select id="sumKelas"></select></div>
      <div class="row"><label>Periode</label><input id="sumPeriode" placeholder="YYYY-MM"></div>
      <div class="row"><label>Hanya Aktif?</label><select id="sumOnly"><option value="true" selected>Ya</option><option value="false">Tidak</option></select></div>
      <table class="grid"><tbody><tr><th>Jumlah Siswa</th><td id="sumSiswa">-</td></tr><tr><th>Total SPP</th><td id="sumSPP">-</td></tr></tbody></table>
    </div>
  </div>

<script>
/* ========= utils ========= */
const API_BASE = window.RBMJ_API_BASE;
const $ = (id)=>document.getElementById(id);
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#039;' }[m])); }
async function apiGet(params){
  const url = new URL(API_BASE);
  Object.entries(params).forEach(([k,v])=> url.searchParams.set(k,v));
  const r = await fetch(url.toString(), { cache:'no-store' });
  if (!r.ok) throw new Error('HTTP '+r.status);
  const data = await r.json();
  if (!data.ok) throw new Error(data.error || 'API error');
  return data.data;
}
function setOpts(sel, arr, map=(v)=>({value:v,label:v})){
  sel.innerHTML = arr.map(v=>{
    const {value,label} = map(v);
    return `<option value="${escapeHtml(value)}">${escapeHtml(label)}</option>`;
  }).join('');
}

/* ========= tabs ========= */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const id = btn.dataset.tab;
    ['pay','inv','out','muk','ros','abs','sum'].forEach(t=>{
      document.getElementById('tab-'+t).style.display = (t===id)?'block':'none';
    });
  });
});

/* ========= branding ========= */
(async function(){
  try{
    const b = await apiGet({action:'brand'});
    if (b && b.name) $('brandTitle').textContent = b.name;
  }catch(_){}
})();

/* ========= kelas/metode shared ========= */
async function loadKelasTo(ids){
  const kelas = await apiGet({action:'listKelas'});
  ids.forEach(id => setOpts($(id), kelas));
}
async function loadMetode(){
  const m = await apiGet({action:'listMetode'});
  setOpts($('payMetode'), m);
}

/* ========= Pembayaran (ringkas) ========= */
async function refreshPayStudents(){
  const kelas = $('payKelas').value, only = $('payOnly').value==='true';
  const rows = await apiGet({action:'listSiswaByKelas', kelas, onlyActive:String(only)});
  setOpts($('payNis'), rows, r=>({value:r.nis,label:`${r.nis} — ${r.nama}`}));
  if (rows.length){
    const n = await apiGet({action:'computeTarif', nis:rows[0].nis, periode:$('payPeriode').value, kelas});
    $('payNominal').value = n;
  } else $('payNominal').value='';
}
$('payKelas').addEventListener('change', refreshPayStudents);
$('payOnly').addEventListener('change', refreshPayStudents);
$('payNis').addEventListener('change', async ()=>{
  if (!$('payNis').value) return;
  const n = await apiGet({action:'computeTarif', nis:$('payNis').value, periode:$('payPeriode').value, kelas:$('payKelas').value});
  $('payNominal').value = n;
});
$('payPeriode').addEventListener('change', async ()=>{
  if (!$('payNis').value) return;
  const n = await apiGet({action:'computeTarif', nis:$('payNis').value, periode:$('payPeriode').value, kelas:$('payKelas').value});
  $('payNominal').value = n;
});
$('btnPay').addEventListener('click', async ()=>{
  const nis=$('payNis').value, prd=$('payPeriode').value, n=$('payNominal').value, m=$('payMetode').value, k=$('payKet').value, kelas=$('payKelas').value;
  if(!nis || !prd || !n){ $('payInfo').textContent='Lengkapi data.'; return; }
  $('payInfo').textContent='Menyimpan...';
  try{
    const url = await apiGet({action:'createPayment', nis, periode:prd, nominal:n, metode:m, ket:k, kelas});
    $('payInfo').innerHTML = `Berhasil. <a href="${url}" target="_blank">Buka Kwitansi PDF</a>`;
  }catch(err){ $('payInfo').textContent = 'Error: '+err.message; }
});

/* ========= Pengeluaran ========= */
$('btnOut').addEventListener('click', async ()=>{
  const t=$('outTgl').value, kat=$('outKat').value, desk=$('outDesk').value, n=$('outNom').value, by=$('outBy').value;
  if(!t || !kat || !desk || !n){ $('outInfo').textContent='Lengkapi data.'; return; }
  $('outInfo').textContent='Menyimpan...';
  try{
    const r = await apiGet({action:'addExpense', tglISO:t, kategori:kat, deskripsi:desk, nominal:n, by});
    $('outInfo').textContent='OK. ID: '+r.id;
  }catch(err){ $('outInfo').textContent='Error: '+err.message; }
});

/* ========= Roster ========= */
async function refreshRoster(){
  const kelas=$('rosKelas').value, only=$('rosOnly').value==='true';
  const rows = await apiGet({action:'roster', kelas, onlyActive:String(only)});
  const tb = $('rosTable').querySelector('tbody');
  tb.innerHTML = rows.map(r=>`<tr><td>${escapeHtml(r[0])}</td><td>${escapeHtml(r[1])}</td></tr>`).join('');
}
$('rosKelas').addEventListener('change', refreshRoster);
$('rosOnly').addEventListener('change', refreshRoster);

/* ========= Absensi ========= */
const absKelas=$('absKelas'), absTanggal=$('absTanggal'), absInfo=$('absInfo'),
      absTable=$('absTable'), absTBody=absTable.querySelector('tbody'),
      btnAbsen=$('btnAbsen'), btnShareWA=$('btnShareWA');

async function fetchAbsensi(){
  absInfo.textContent='Memuat absensi...';
  btnShareWA.disabled = true;
  absTable.style.display='none';
  absTBody.innerHTML='';
  const kelas = absKelas.value, tgl=absTanggal.value;
  if(!kelas || !tgl){ absInfo.textContent='Pilih kelas & tanggal.'; return; }
  try{
    const rows = await apiGet({action:'absensiList', kelas, tglISO:tgl});
    if(!rows.length){ absInfo.textContent='Belum ada baris absensi untuk kombinasi ini.'; return; }
    absTBody.innerHTML = rows.map(r=>(
      `<tr><td>${escapeHtml(r.nis)}</td><td>${escapeHtml(r.nama)}</td><td>${escapeHtml(r.kehadiran)}</td><td>${escapeHtml(r.ket||'')}</td></tr>`
    )).join('');
    absTable.style.display='';
    absInfo.textContent=`OK. ${rows.length} baris untuk ${kelas} / ${tgl}.`;
    btnShareWA.disabled = false;
    btnShareWA.onclick = ()=> shareWAAbsensi(kelas, tgl, rows);
  }catch(err){ absInfo.textContent='Error memuat: '+err.message; }
}
btnAbsen.addEventListener('click', async ()=>{
  const kelas = absKelas.value, tgl = absTanggal.value;
  if (!kelas || !tgl){ absInfo.textContent = 'Pilih kelas & tanggal.'; return; }
  btnAbsen.disabled = true; absInfo.textContent = 'Membuat template...';
  try{
    await apiGet({action:'prepareAbsensi', kelas, tglISO:tgl});
    absInfo.textContent = `OK. Template pada sheet Absensi (${kelas} / ${tgl}).`;
    await fetchAbsensi();
  }catch(err){ absInfo.textContent = 'Error: '+err.message; }
  finally{ btnAbsen.disabled = false; }
});
absKelas.addEventListener('change', fetchAbsensi);
absTanggal.addEventListener('change', fetchAbsensi);

function shareWAAbsensi(kelas, tgl, rows){
  const counts = rows.reduce((m,r)=>{ m[r.kehadiran]=(m[r.kehadiran]||0)+1; return m; }, {});
  const nonHadir = rows.filter(r=>r.kehadiran!=='Hadir');
  let msg = `Absensi ${kelas}\n${tgl}\n\nRingkasan:\n`;
  Object.keys(counts).sort().forEach(k=> msg += `• ${k}: ${counts[k]}\n`);
  if (nonHadir.length){
    msg += `\nTidak Hadir / Izin / Sakit:\n`;
    nonHadir.forEach(r=>{
      const ket = r.ket ? ` — ${r.ket}` : '';
      msg += `- ${r.nama} (${r.kehadiran})${ket}\n`;
    });
  }
  msg += `\nPortal: ${location.href}`;
  const wa = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(wa, '_blank');
}

/* ========= Resume ========= */
async function refreshResume(){
  const kelas=$('sumKelas').value, prd=$('sumPeriode').value, only=$('sumOnly').value==='true';
  const r = await apiGet({action:'kelasResume', kelas, periode:prd, onlyActive:String(only)});
  $('sumSiswa').textContent = r.siswaAktif;
  $('sumSPP').textContent = r.totalSPPLabel;
}
['sumKelas','sumPeriode','sumOnly'].forEach(id=> $(id).addEventListener('change', refreshResume));

/* ========= init ========= */
(async function init(){
  // tanggal default hari ini
  const now = new Date(); const iso = new Date(now.getTime()-now.getTimezoneOffset()*60000).toISOString().slice(0,10);
  $('absTanggal').value = iso;

  // periode default YYYY-MM
  const ym = iso.slice(0,7); $('payPeriode').value = ym; $('sumPeriode').value = ym;

  await loadKelasTo(['payKelas','rosKelas','absKelas','sumKelas']);
  await loadMetode();

  refreshPayStudents();
  refreshRoster();
  fetchAbsensi();
  refreshResume();
})();
</script>
</body>
</html>
