<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>RBMJepang</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:900px;margin:20px auto;padding:0 12px;background:#f6f7fb}
    h1{font-size:22px}
    label{display:block;margin:8px 0 4px;font-size:12px;color:#555}
    input,select,button{padding:10px;border:1px solid #ddd;border-radius:10px}
    input,select{width:100%}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .card{border:1px solid #eee;border-radius:14px;padding:12px;margin:10px 0;background:#fff}
    button{background:#111827;color:#fff;border:0;border-radius:12px;cursor:pointer}
    small{color:#666}
    a.btn{display:inline-block;padding:10px 12px;border-radius:10px;background:#0ea5e9;color:#fff;text-decoration:none}
  </style>
</head>
<body>
  <h1>RBMJepang</h1>

  <div class="card">
    <h3>Pembayaran & Kwitansi</h3>
    <div class="row">
      <div>
        <label>Tanggal</label>
        <input id="tgl" type="date">
      </div>
      <div>
        <label>Kelas</label>
        <select id="kelas"></select>
      </div>
    </div>
    <div class="row">
      <div>
        <label>Siswa</label>
        <select id="siswa"></select>
      </div>
      <div>
        <label>Item</label>
        <input id="item" value="SPP">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Nominal</label>
        <input id="nominal" type="number" min="0">
        <small id="hint"></small>
      </div>
      <div>
        <label>Metode</label>
        <select id="metode"><option>Tunai</option><option>Transfer</option></select>
      </div>
    </div>
    <label>Catatan</label>
    <input id="catatan">
    <div class="row">
      <button id="btnSave">Simpan & Buat Kwitansi</button>
      <a id="waLink" class="btn" target="_blank">WhatsApp</a>
    </div>
    <div id="out" style="margin-top:8px;color:#666"></div>
  </div>

<script>
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbz8InhGRUZvYvmMH0NrPvwRnt12eeuHyd50W59scrmCBfEUQfLEwb2HLM-5lOsqQ_Fx/exec'; 

function q(s){return document.querySelector(s);}

async function api(action, payload={}, method='POST'){
  const url = BACKEND_URL + '?action=' + encodeURIComponent(action);
  const opt = (method==='GET')
    ? { method:'GET' }
    : { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) };
  const res = await fetch(url, opt);
  const json = await res.json();
  if(!json.ok) throw new Error(json.error||'API error');
  return json.data;
}

async function loadKelas(){
  const data = await api('list_kelas', {}, 'GET');
  const sel = q('#kelas'); sel.innerHTML='';
  data.forEach(k => sel.add(new Option(k.nama, k.id)));
  await loadSiswaByKelas(sel.value);
}
async function loadSiswaByKelas(kelasId){
  const data = await api('list_siswa_by_kelas', {kelas_id:kelasId}, 'GET');
  const sel = q('#siswa'); sel.innerHTML='';
  data.forEach(s => sel.add(new Option(s.nama, s.id)));
  tryPreviewSPP();
}
q('#kelas').addEventListener('change', e => loadSiswaByKelas(e.target.value));

async function tryPreviewSPP(){
  const kelas_id = q('#kelas').value;
  const siswa_id = q('#siswa').value;
  if(!kelas_id || !siswa_id) return;
  const r = await api('spp_preview', {kelas_id, siswa_id}, 'GET');
  q('#nominal').value = r.nominal || '';
  q('#hint').textContent = r.tarif ? `Tarif: ¥${Number(r.tarif).toLocaleString()} → Bayar: ¥${Number(r.nominal).toLocaleString()}` : '';
}
['#siswa','#kelas','#item'].forEach(id => q(id).addEventListener('change', tryPreviewSPP));

q('#tgl').value = new Date().toISOString().slice(0,10);

q('#btnSave').addEventListener('click', async () => {
  try{
    const tanggal = q('#tgl').value;
    const payload = {
      tanggal,
      periode: (tanggal||'').slice(0,7),
      kelas_id: q('#kelas').value,
      siswa_id: q('#siswa').value,
      item: q('#item').value,
      nominal: q('#nominal').value,
      metode: q('#metode').value,
      catatan: q('#catatan').value
    };
    const saved = await api('save_pembayaran', payload, 'POST');
    const doc = await api('generate_kwitansi', { pembayaran_id: saved.id }, 'POST');
    q('#out').innerHTML = `<a href="${doc.url}" target="_blank">Buka Kwitansi PDF</a>`;
    q('#waLink').href = doc.wa;
  }catch(e){
    alert(e.message||e);
  }
});

// start
loadKelas();
</script>
</body>
</html>
